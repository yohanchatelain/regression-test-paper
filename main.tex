\documentclass{article}

% Language setting Replace `english' with e.g. `spanish' to change the document
% language
\usepackage[english]{babel}
\usepackage{caption}
\usepackage{subcaption}
\usepackage{makecell}
\usepackage[toc,page]{appendix}
\setlength{\marginparwidth}{2cm}
\usepackage{todonotes}
\usepackage{soul}
\usepackage{pdflscape}

% Set page size and margins Replace `letterpaper' with `a4paper' for UK/EU
% standard size
\usepackage[letterpaper,top=2cm,bottom=2cm,left=3cm,right=3cm,marginparwidth=1.75cm]{geometry}

% Useful packages
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{graphicx}
\usepackage{xspace}
\usepackage{xcolor}% http://ctan.org/pkg/xcolor
\usepackage{hyperref}
\usepackage{colortbl}
\usepackage{dsfont}

\setlength{\marginparwidth}{2cm}
\usepackage{todonotes}

\newcommand{\TODO}[1]{\color{red}\textsc{TODO:} #1\color{black}\xspace}
\newcommand{\TG}[1]{\color{blue}\textsc{From Tristan:} #1\color{black}\xspace}
\newcommand{\fmriprep}{fMRIPrep\xspace}
\newcommand{\fwhm}{\textsc{FWHM}}

\newcommand\Mark[2][8.4]{%
  \rlap{\tikz[baseline=(current bounding box.south)]{
        \shade[left color=\color{red}, right color=\color{green}, middle color=\color{yellow}]
               (0,0) rectangle ++(#1*#2/100,0.3);}%
  }%
}

% Cluster failure: Why fMRI inferences for spatial extent have inflated
% false-positive https://www.pnas.org/doi/pdf/10.1073/pnas.1602413113

\title{Non-regression tests for structural MRI analysis: a numerical uncertainty approach}
\author{Yohan Chatelain, Loic Tetrel, Christopher J. Markiewicz, Gregory Kiar,\\ Oscar Esteban,  Pierre Bellec, Tristan Glatard}

\begin{document}
\maketitle

\begin{abstract}
    To ensure the long-term reproducibility of analyses, neuroimaging tools have developed long-term support (LTS) versions that require automated testing methods. Therefore, non-regression testing is crucial for neuroimaging to avoid breaking numerical reproducibility across code updates. However, the lack of universally accepted ground truth or acceptable bounds of variation poses a challenge in the neuroimaging community. In this study, we propose a statistical test based on numerical uncertainty quantification to address this problem. We apply this method to \fmriprep, a widely-used neuroimaging tool, and detect significant changes within LTS versions. Our approach requires minimal statistical assumptions and no ground truth, making it applicable in various domains and scenarios. The results of this study contribute to enhancing the reliability and reproducibility of neuroimaging research by providing a robust and flexible method for numerical quality testing.
\end{abstract}

{
\small
\textbf{\texttt{Target journals}}: PLOS ONE, Frontiers in Neuroinformatics,  IEEE Transactions on
Software Engineering. \url{https://www.computer.org/csdl/journal/ts}
}

\section{Introduction}

\TG{Good writing but logic needs to be revised: numerical accuracy is a tool (method) to build a non-regression test. The primary goal is to build a non-regression test usable in the context of an LTS, not to evaluate numerical accuracy.}

In the field of software engineering, non-regression testing plays a critical role in ensuring the stability and reliability of software systems over time. This involves testing software updates to verify that they do not introduce new bugs or regressions compared to previous versions. It is an important quality assurance process that helps identify and fix potential issues before they impact users.

In neuroimaging, tools have been developed and utilized by the scientific community for several decades now, enabling researchers to study the human brain with unprecedented detail and precision. The maturity of neuroimaging software tools pushed them to develop long-term support (LTS) versions to release stable and reliable software versions for long-term use. But LTS requires inevitable updates for security reasons, bug fixes, end-of-life (EOL) and updates dependencies. Despite the widespread use of these tools, there are still variabilities observed between different software tools and even between different versions of the same tool, which can impact the quality and reliability of the results obtained~\cite{glatard2015reproducibility, bhagwat2021understanding}.

A significant obstacle in assessing neuroimaging software stems from the lack of a well-established reference or ground truth for comparative purposes. Even determining an acceptable tolerance threshold proves to be particularly challenging, given the absence of universally accepted standards in the field. Methods such as simulations, phantoms, and ex-vivo data have limitations and do not provide a comprehensive solution for defining acceptable variation bounds. Hence, conducting thorough testing is imperative to ensure that the quality of results does not regress due to bug fixes and updates applied to LTS versions of neuroimaging software tools.

To ensure that output values remain within an acceptable range of variations, one way is to account for the errors introduced during calculations due to the use of finite-precision arithmetic, such as the floating-point model. Such errors may arise when changes occur in the computational environment, including the computing architecture, the operating system, or the version of a dependent library for a given application. A well-established technique for estimating this uncertainty is Monte Carlo Arithmetic (MCA), a member of the family of stochastic arithmetics. Stochastic arithmetic models floating-point calculation errors with random variables, transforming the challenging task of symbolic round-off error analysis into a more tractable statistical sampling problem. Importantly, MCA is not dependent on the specificities of the application domain, rendering it applicable across a diverse range of cases and scenarios. Notably, MCA has been successfully utilized in neuroimaging to simulate numerical variability resulting from changes in operating systems~\cite{salari2021accurate} and to evaluate the reliability of brain networks~\cite{kiar2021numerical}.

% Besides, the images generated by neuroimaging tools undergo several preprocessing steps, including image reconstruction, registration, and normalization, to ensure accurate and reliable analysis. These steps are critical in obtaining high-quality structural brain images that serve as a baseline for further analyses, such as functional imaging. Therefore, it is imperative to ensure a high level of numerical quality for these results, particularly over long-term support (LTS) patches.

% and therefore condition the quality of the subsequent analyses. are important to obtaining accurate and reliable high-quality structural brain images. Since these images serve as a basis for further analyses, it makes the preprocessing steps a mandatory and critical component of the process. Therefore, ensuring a stable quality for these results over long-term support (LTS) patches is imperative for the robustness and reliability of subsequent analyses in the neuroimaging pipeline.

In this work, we propose a novel approach to non-regression testing in neuroimaging based on numerical uncertainty quantification. We leverage numerical variability, which is a critical property of scientific data analyses, to define acceptable variation bounds around an output of reference, using a set of representative datasets. Our approach is not specific to any particular numerical scheme and relies on a few statistical assumptions such as normality and independence, making it applicable to a wide range of scenarios. Hence, the proposed approach is not limited to neuroimaging and could be applied to other domains where ground truth is not available or acceptable variation bounds are difficult to define. We focus on preprocessing stages in neuroimaging, as they precede any further analyses, such as functional imaging or tractography. These preprocessing steps encompass image reconstruction, registration, and normalization, which yield structural brain images. As a result, it is crucial to guarantee consistent quality for these images over long-term support (LTS) patches, which explains our emphasis on these initial stages.

Overall, the main contribution of this paper is to build and evaluate a non-regression test for structural MRI analysis using numerical uncertainty quantification, with the LTS of the \fmriprep software as the baseline. By leveraging numerical variability and providing a comprehensive method for defining acceptable variation bounds, we aim to enhance the accuracy and reliability of neuroimaging software and contribute to the field of non-regression testing in software engineering.

\section{Non-regression test design}

The objective of our non-regression testing is to determine whether the results generated by an updated version of a given application "$\Lambda$" or those obtained in a different execution environment deviate from the reference results.
We consider "$\Lambda$" outputs to be 3D images with $v$ voxels. To achieve this, we initially sample the reference results distribution by introducing random numerical perturbations during the execution of a fixed version of "$\Lambda$" considered as a reference version. This approach simulates the variability that may arise due to changes in the execution environment. This sampling yields $n$ 3D images. Conversely, the test images are calculated without random perturbations, using different updated versions of "$\Lambda$" and computing environments. Once the test images are gathered, we perform a z-test for each voxel $x_i$ ($i\leq v$) in every test image, utilizing the mean and standard deviation estimated from the $n$ perturbed results. The test computes a p-value under the null hypothesis $H_{0,i}$, which assumes that the value generated by the tested version belongs to the reference distribution:
\begin{equation} \label{eq:pval}
    p_i(z_i) = 2 \left(1-\Phi(z_i)\right),
\end{equation}
where $\Phi$ is the cumulative distribution function of the normal centered
Gaussian and:
\begin{equation*}
    z_i = \frac{x_i-\hat \mu_i}{\hat \sigma_i},
\end{equation*}
where $x_i$ is the voxel intensity obtained after pre-processing the output of the tested version, $v$ is the number of voxels in the application output image, and $\hat \mu_i$ and $\hat \sigma_i$ are the mean and standard deviation voxel intensity estimated from the $n$ perturbed results. $H_{0,i}$ is rejected when $p_i$ is lower than a threshold $\alpha$ from which the confidence level of the test (1-$\alpha$)\% is also defined. The z-test assumes that perturbed voxel intensities are normally distributed. To capture anatomical variability, we perform this test on a representative set of brain structural images. Table~\ref{tab:notations} recapitulates the notations.

\begin{figure}
    \centering
    \includegraphics[width=\linewidth]{figures/stat_test_procedure.pdf}
    \caption{Test workflow. \TG{La figure est difficilement lisible (fonte trop petite). Elle pourrait aussi etre rendue plus claire. Ameliorer la legende.}}
    \label{fig:test_workflow}
\end{figure}

\subsection{Numerical variability estimation}

To estimate the distribution of reference results across execution environments and compute $\hat \mu$ and $\hat \sigma$ (Equation~\ref{eq:pval}), we sample results distributions by applying two types of numerical perturbations to the computations: (1) Random Rounding (RR), which randomly rounds function outputs in the GNU libmath and (2) Random Seed (RS), which varies the random seed used in the target application.

Random Rounding (RR) consists in rounding the exact result of a floating-point arithmetic operation toward the previous or next floating-point number with equal probability~\cite{forsythe1959reprint}. RR is equivalent to applying Monte-Carlo Arithmetic (MCA~\cite{parker1997monte}) to double-precision numbers with a virtual precision of 53 bits and to single-precision numbers with a virtual precision of 24 bits, which was shown to accurately simulate the effect of operating system updates on the structural MRI pre-processing pipelines of the Human Connectome Project (HCP) when applied to GNU libmath~\cite{salari2021accurate}. Structural HCP pipelines consist of tools assembled from the FSL~\cite{jenkinson2012fsl} and Freesurfer~\cite{fischl2012freesurfer} toolboxes, which makes them conceptually very similar to the structural fMRIPrep pipeline targeted by our study.

RR is rigorously implemented in several tools including CADNA~\cite{jezequel2008cadna}, Verrou~\cite{fevotte2016verrou}, and Verificarlo~\cite{denis2016verificarlo}. However, these tools incur substantial performance overheads which makes them difficult to use with a compute-intensive pipeline such as those used in neuroimaging. In addition, only Verrou supports RR instrumentation of GNU libmath~\cite{fevotte2019debugging}, and it does so by relying on quadruple precision, which is not scalable to the entire fMRIPrep pipeline. Therefore, we implemented a fast, approximate RR method by randomly adding or removing 1 ulp (unit in the last place) to the outputs of GNU libmath functions. Our implementation, available on GitHub (\href{https://github.com/verificarlo/fuzzy/blob/master/docker/resources/libmath/fast/src/wrapping_script.c}{\url{github.com/verificarlo/fuzzy}}\footnote{https://github.com/verificarlo/fuzzy/blob/master/docker/resources/libmath/fast/src/wrapping\_script.c}),  only approximates RR as it applies the random perturbation to an already rounded result instead of to the exact result as done in rigorous implementations. In practice, computing the exact result returned by GNU libmath functions is too expensive for our use case.

Random Seeds (RS) defines pseudo-random number sequences used in various numerical procedures such as algorithm initialization (e.g., in k-means) or stochastic optimization (e.g., stochastic gradient descent). \fmriprep provides an interface to set the random seed for all of the pipeline components, including ANTs~\cite{avants2009advanced} which is employed for linear and non-linear registration. This process aligns images into a common space, enabling statistical analysis.

RS and RR trigger different types of variability. RR can be applied transparently to any application while RS is more specific to the type of analysis. Conversely, RR incurs a substantial performance overhead whereas RS does not.

\TG{Refer to table 1 and figure 1 in the text}

\subsection{fMRIprep results preprocessing}

The non-regression test applies to the main structural derivative produced by \fmriprep: the T1-weighted MRI image corrected for intensity non-uniformity using \texttt{N4BiasFieldCorrection} from \texttt{ANTS} and transformed to template space using \texttt{antsRegistration}, named \texttt{desc-preproc\_T1w} in the \fmriprep outputs and $X_k$ ($k < n$) in the remainder of this paper. In addition to $X_k$, \fmriprep produces a brain mask ($B_k$), a segmentation into grey matter, white matter and cerebrospinal fluid tissues, as well as probability maps for each of these tissues.

Before computing the p-values in Equation~\ref{eq:pval}, we apply the following pre-processing steps to $X_k$: brain masking, smoothing, and intensity normalization. For brain masking, we mask $X_k$ with the union of the brain masks produced across all perturbed results. We use the union of the brain masks rather than their intersection to capture variability across $B_k$ masks. For smoothing, we apply a spatial 3D Gaussian smoothing kernel with Full-Width at Half Maximum (\fwhm) ranging from 0~mm to 20~mm. For intensity normalization, we apply a min-max scaling to the smoothed intensities to scale them to [0,1].
We have as a result a pre-processed image $X_k^\star$ from which we build the non-regression test.

\subsection{Handling multiple comparisons}

Handling multiple comparisons is a critical component of statistical testing in neuroimaging given the high number of voxels tested for each 3D structural image---typically more than 10 million~\cite{NICHOLS2007246}. The non-regression test defined in Equation~\ref{eq:pval} consists of independent z-tests performed for each of the $v$ voxels of each test image, resulting in a set of $v$ p-values $p_i$, $i < v$. We corrected for multiple comparisons by adjusting the p-value threshold. We use the classical Bonferroni correction that simply divides $\alpha$ by the number of multiple comparisons performed. As a result, the tested \fmriprep result is considered part of the reference distribution iff:
\begin{equation}
    \label{eq:bonferroni}
    \forall i, \quad i < v, \quad p_i < \frac{\alpha}{v}.
\end{equation}

\begin{table}
    \centering
    \begin{tabular}{c|l}
        $i$              & index of the voxel within brain mask                                          \\
        $v$              & number of voxels within the brain mask $B$                                    \\
        $k$              & index of the perturbed sample                                                 \\
        $n$              & perturbed outputs sample size                                                 \\
        $x_i$            & voxel intensity                                                               \\
        $z_i$            & z-score of voxel intensity                                                    \\
        $p_i$            & p-value of voxel intensity                                                    \\
        $\hat{\mu_i}$    & average voxel intensity across perturbed samples                              \\
        $\hat{\sigma_i}$ & standard deviation of voxel intensity across perturbed samples                \\
        $B_k$            & brain mask produced by \fmriprep                                              \\
        $B$              & union of $B_k$ masks                                                          \\
        $X_k$            & preprocessed T1 image                                                         \\
        $X_k^{\star}$    & $X_k$ masked with $B$, min-max scaled and spatially smoothed                  \\
        $\hat{s}$        & average number of significant bits across the image                           \\
        $\Phi$           & cumulative distribution function of the normal centered Gaussian distribution \\
        $\chi^2_{n-1}$   & Chi-2 distribution with n-1 degrees of freedom                                \\
    \end{tabular}
    \caption{Notations}
    \label{tab:notations}
\end{table}

% \begin{table}[] \centering \begin{tabular}{c|c|c|c} & Negatives & Positives &
%     \\
%          True noise  & $V_{0N}$ & $\mathbf{V_{0P}}$ & $v_0$ \\
%          True signal & $V_{1N}$ & $V_{1P}$ & $v_1$ \\
%                      & $V_N$    & ${V_P}$    & $v$ \end{tabular}
%     \caption{Cross-classification of all $v$ voxels in an image.}
%     \label{tab:cross-classification-fp} \end{table}


\subsection{Numerical variability measure}

By examining uncertainty maps, we can identify regions within the brain that are highly unstable and challenging to process. Investigating numerical variability offers valuable information regarding the adequacy of the sample size. Highly unstable subjects may require a larger number of statistical observations to accurately estimate the underlying distribution compared to subjects who are easier to register. Moreover, analyzing each subject's variability individually provides valuable insights into their sensitivity to minor perturbations. Preprocessing includes optimization steps that are highly reliant on the quality of image acquisition which means that subjects are likely to exhibit different responses to small perturbations.

To assess the numerical quality, we use the "number of significant bits" metric, which distinguishes between the bits that represent signal and those that constitute noise. We compute the number of significant bits $\hat{s}$ with probability $p_s=0.95$ and confidence $1-\alpha_s=0.95$ using the \texttt{significant\_digits} package v0.1.2 available at \url{https://github.com/verificarlo/significantdigits} that implements the Centered Normality Hypothesis approach described in~\cite{sohier2021confidence}:

\[
    \hat{s} = -\log_2 \left| \frac{\hat{\sigma}}{\hat{\mu}} \right| - \delta(n, \alpha_s, p_s)
\]
where $\hat{\sigma}$ and $\hat{\mu}$ are the voxelwise average and standard deviation over the $X_k^\star$ perturbed results ($k \leq n$), and
\[
    \delta(n, \alpha, p) =
    \left[
        \frac{1}{2} \log_2 \left( \frac{n-1}{\chi^2_{1-\alpha/2}} \right) +
        \log_2 \left( \Phi^{-1} \left( \frac{p+1}{2} \right) \right)
        \right]
\]
is a penalty value to have an estimator of $s$ with a probability $p_s$ and a confidence level $1-\alpha_s$ for a sample size $n$. $\Phi^{-1}$ is the inverse cumulative distribution of the standard normal distribution and $\chi^2$ is the Chi-2 distribution with n-1 degrees of freedom.

\subsection{Datasets}

We selected eight test subjects from sub-datasets in the OpenNeuro~\cite{markiewicz2021openneuro} data-sharing platform, representing a diversity of ages, sex, and study designs. The datasets include a motion study with children (ds000256), a long-term memory study with young adults (ds001748), and a motor process study with adults (ds002338). In addition, two sub-datasets involve steps of the pipeline that can affect its reproducibility, namely different field maps (ds001600) and non-structural images (ds001771). Table~\ref{table:dataset_info} lists the dimension, voxels resolution, age and sex of each subject in the dataset.

\begin{table}
    \begin{center}
        \begin{tabular}{c|c|l|c|c|c|c|c}
            Index & Dataset  & Subject     & Dimension ($x,y,z$)         & Voxel resolution            & Data type & Age     & Sex \\
                  &          &             &                             & $mm^3$ ($x,y,z$)            &           & (years) &     \\
            \hline
            1     & ds001600 & sub-1       & $176 \times 256 \times 256$ & $1.0 \times 1.0 \times 1.0$ & int16     & -       & -   \\
            2     & ds001771 & sub-36      & $256 \times 320 \times 320$ & $0.8 \times 0.8 \times 0.8$ & int16     & 22      & F   \\
            3     & ds000256 & sub-CTS201  & $256 \times 256 \times 256$ & $1.0 \times 1.0 \times 1.0$ & int16     & 8.68    & M   \\
            4     & ds000256 & sub-CTS210  & $224 \times 256 \times 256$ & $0.8 \times 0.8 \times 0.8$ & int16     & 7.63    & F   \\
            5     & ds001748 & sub-adult15 & $176 \times 240 \times 256$ & $1.0 \times 1.0 \times 1.0$ & float32   & 21      & M   \\
            6     & ds001748 & sub-adult16 & $176 \times 240 \times 256$ & $1.0 \times 1.0 \times 1.0$ & float32   & 21      & F   \\
            7     & ds002338 & sub-xp201   & $176 \times 512 \times 512$ & $1.0 \times 0.5 \times 0.5$ & int16     & 41      & F   \\
            8     & ds002338 & sub-xp207   & $176 \times 512 \times 512$ & $1.0 \times 0.5 \times 0.5$ & int16     & 39      & M   \\
        \end{tabular}
    \end{center}
    \caption{Dimension, voxels resolutions, age and sex of each subject in the dataset.}
    \label{table:dataset_info}
\end{table}

\subsection{Computing infrastructure}

We processed the dataset using the Narval cluster managed by Calcul Qu\'ebec and Compute Canada. With our job submission parameters, we could access 1,145 computing nodes with 64 cores per node and 2 $\times$ AMD Rome 7532 @ 2.40 GHz 256M cache L3. We executed \fmriprep in a Singularity container built from a Docker image available on dockerhub \texttt{yohanchatelain/fmriprep-fuzzy:20.2.1}. The container image used Ubuntu \texttt{16.04.6 LTS}, GNU libc/libmath \texttt{2.23}, kernel \texttt{4.18.0-372.19.1} \texttt{.el8\_6.x86\_64}, and fMRIPrep version \texttt{20.2.1}. We disabled multi-threading in fMRIPrep, fixed the random seed for skull stripping as well as in fMRIPrep (RR condition only), and verified that in these conditions fMRIPrep results were bit-to-bit reproducible.
We used Fuzzy \texttt{v0.9.1-a} built with Verificarlo version \texttt{v0.9.1}.

\section{Results}

We computed 30 perturbed results for each of the 8 subjects and each of the two perturbations RR and RS. We also computed an unperturbed IEEE result for each subject using the
random seed used in RR (42). For each perturbation, we measured the uncertainty of fMRIPrep in terms of significant bits, and we built the non-regression test using different values of FWHM smoothing and confidence level.

\TG{Consider rewording the sub-section titles to summarize the main results}

\subsection{Measured uncertainty}

Overall, the three types of perturbations (RR, RS, RR+RS) created uncertainties of comparable magnitude (Figure~\ref{fig:significant-digits}). The measured uncertainty is high, with mean significant bits ranging from 2 bits to 10 bits out of the 12 bits available in the data \TG{can we better quantify this?}. Numerically, \fmriprep appears to be highly sensitive to the numerical and random seed perturbations. We also observe substantial discrepancies across subjects. For a given smoothing kernel size, the number of significant bits frequently varies in the ratio of 1 to 3 across subjects. Overall, smoothing tends to reduce numerical uncertainty, however, this behavior is in general not monotonous and varies across subjects.

The uncertainty measured across perturbed samples showed regional variations compatible with anatomical features (Figure~\ref{fig:uncertainty-maps}). In particular, uncertainty was
maximal at the border of the brain mask \TG{this is not obvious from the figure}, and it was overall higher in the gray matter than in the white matter.
This is consistent with previous observations of numerical uncertainty in structural brain image analysis~\cite{salari2021accurate}.
In addition, uncertainty was also maximal in some focal regions, suggesting that non-linear registration may be unstable in these regions. Our non-regression test will therefore be more tolerant in these regions.

\begin{figure}
    \centering
    \includegraphics[width=\linewidth]{figures/stats.pdf}
    \caption{Voxel-wise means of mean, standard deviation and significant bits
        measured across n=30 perturbed samples for 3 types of perturbations and 8
        subjects. For each subject, we computed statistics in the union of the brain
        masks among n=30 perturbed samples. \TG{Put "FWHM (mm)" above the color caption. Use subject indices (not names) in the caption.}}
    \label{fig:significant-digits}
\end{figure}

\begin{landscape}
    \begin{figure}

        \vspace*{-2cm}
        \centering
        %% sub 1
        \begin{subfigure}[b][][c]{0.01\paperwidth} 1 \vspace*{-45pt} \end{subfigure}
        \begin{subfigure}[t]{0.2\paperheight}
            \centering
            IEEE (T1 intensity)
            \includegraphics[width=\textwidth]{figures/sig/15mm/ieee_ds001600_sub-1.pdf}
        \end{subfigure}
        \begin{subfigure}[t]{0.2\paperheight}
            \centering
            RR (significant bits)
            \includegraphics[width=\textwidth]{figures/sig/15mm/rr_ds001600_sub-1_sig.pdf}
        \end{subfigure}
        \begin{subfigure}[t]{0.2\paperheight}
            \centering
            RS (significant bits)
            \includegraphics[width=\textwidth]{figures/sig/15mm/rs_ds001600_sub-1_sig.pdf}
        \end{subfigure}
        \begin{subfigure}[t]{0.2\paperheight}
            \centering
            RS (significant bits)
            \includegraphics[width=\textwidth]{figures/sig/15mm/rs_ds001600_sub-1_sig.pdf}
        \end{subfigure} \\
        %% sub 2
        \begin{subfigure}[b][][c]{0.01\paperwidth} 2 \vspace*{15pt} \end{subfigure}
        \begin{subfigure}[t]{0.2\paperheight}
            \centering
            \includegraphics[width=\textwidth]{figures/sig/15mm/ieee_ds001771_sub-36.pdf}
        \end{subfigure}
        \begin{subfigure}[t]{0.2\paperheight}
            \centering
            \includegraphics[width=\textwidth]{figures/sig/15mm/rr_ds001771_sub-36_sig.pdf}
        \end{subfigure}
        \begin{subfigure}[t]{0.2\paperheight}
            \centering
            \includegraphics[width=\textwidth]{figures/sig/15mm/rs_ds001771_sub-36_sig.pdf}
        \end{subfigure}
        \begin{subfigure}[t]{0.2\paperheight}
            \centering
            \includegraphics[width=\textwidth]{figures/sig/15mm/rr.rs_ds001771_sub-36_sig.pdf}
        \end{subfigure} \\
        %% sub 3
        \begin{subfigure}[b][][c]{0.01\paperwidth} 3 \vspace*{15pt} \end{subfigure}
        \begin{subfigure}[t]{0.2\paperheight}
            \centering
            \includegraphics[width=\textwidth]{figures/sig/15mm/ieee_ds000256_sub-CTS201.pdf}
        \end{subfigure}
        \begin{subfigure}[t]{0.2\paperheight}
            \centering
            \includegraphics[width=\textwidth]{figures/sig/15mm/rr_ds000256_sub-CTS201_sig.pdf}
        \end{subfigure}
        \begin{subfigure}[t]{0.2\paperheight}
            \centering
            \includegraphics[width=\textwidth]{figures/sig/15mm/rs_ds000256_sub-CTS201_sig.pdf}
        \end{subfigure}
        \begin{subfigure}[t]{0.2\paperheight}
            \centering
            \includegraphics[width=\textwidth]{figures/sig/15mm/rr.rs_ds000256_sub-CTS201_sig.pdf}
        \end{subfigure} \\
        %% sub 4
        \begin{subfigure}[b][][c]{0.01\paperwidth} 4 \vspace*{15pt} \end{subfigure}
        \begin{subfigure}[t]{0.2\paperheight}
            \centering
            \includegraphics[width=\textwidth]{figures/sig/15mm/ieee_ds000256_sub-CTS210.pdf}
        \end{subfigure}
        \begin{subfigure}[t]{0.2\paperheight}
            \centering
            \includegraphics[width=\textwidth]{figures/sig/15mm/rr_ds000256_sub-CTS210_sig.pdf}
        \end{subfigure}
        \begin{subfigure}[t]{0.2\paperheight}
            \centering
            \includegraphics[width=\textwidth]{figures/sig/15mm/rs_ds000256_sub-CTS210_sig.pdf}
        \end{subfigure}
        \begin{subfigure}[t]{0.2\paperheight}
            \centering
            \includegraphics[width=\textwidth]{figures/sig/15mm/rr.rs_ds000256_sub-CTS210_sig.pdf}
        \end{subfigure} \\
        %% sub 5
        \begin{subfigure}[b][][c]{0.01\paperwidth} 5 \vspace*{15pt} \end{subfigure}
        \begin{subfigure}[t]{0.2\paperheight}
            \centering
            \includegraphics[width=\textwidth]{figures/sig/15mm/ieee_ds001748_sub-adult15.pdf}
        \end{subfigure}
        \begin{subfigure}[t]{0.2\paperheight}
            \centering
            \includegraphics[width=\textwidth]{figures/sig/15mm/rr_ds001748_sub-adult15_sig.pdf}
        \end{subfigure}
        \begin{subfigure}[t]{0.2\paperheight}
            \centering
            \includegraphics[width=\textwidth]{figures/sig/15mm/rs_ds001748_sub-adult15_sig.pdf}
        \end{subfigure}
        \begin{subfigure}[t]{0.2\paperheight}
            \centering
            \includegraphics[width=\textwidth]{figures/sig/15mm/rr.rs_ds001748_sub-adult15_sig.pdf}
        \end{subfigure} \\
        %% sub 6
        \begin{subfigure}[b][][c]{0.01\paperwidth} 6 \vspace*{15pt} \end{subfigure}
        \begin{subfigure}[t]{0.2\paperheight}
            \centering
            \includegraphics[width=\textwidth]{figures/sig/15mm/ieee_ds001748_sub-adult16.pdf}
        \end{subfigure}
        \begin{subfigure}[t]{0.2\paperheight}
            \centering
            \includegraphics[width=\textwidth]{figures/sig/15mm/rr_ds001748_sub-adult16_sig.pdf}
        \end{subfigure}
        \begin{subfigure}[t]{0.2\paperheight}
            \centering
            \includegraphics[width=\textwidth]{figures/sig/15mm/rs_ds001748_sub-adult16_sig.pdf}
        \end{subfigure}
        \begin{subfigure}[t]{0.2\paperheight}
            \centering
            \includegraphics[width=\textwidth]{figures/sig/15mm/rr.rs_ds001748_sub-adult16_sig.pdf}
        \end{subfigure} \\
        %% sub 7
        \begin{subfigure}[b][][c]{0.01\paperwidth} 7 \vspace*{15pt} \end{subfigure}
        \begin{subfigure}[t]{0.2\paperheight}
            \centering
            \includegraphics[width=\textwidth]{figures/sig/15mm/ieee_ds002338_sub-xp201.pdf}
        \end{subfigure}
        \begin{subfigure}[t]{0.2\paperheight}
            \centering
            \includegraphics[width=\textwidth]{figures/sig/15mm/rr_ds002338_sub-xp201_sig.pdf}
        \end{subfigure}
        \begin{subfigure}[t]{0.2\paperheight}
            \centering
            \includegraphics[width=\textwidth]{figures/sig/15mm/rs_ds002338_sub-xp201_sig.pdf}
        \end{subfigure}
        \begin{subfigure}[t]{0.2\paperheight}
            \centering
            \includegraphics[width=\textwidth]{figures/sig/15mm/rr.rs_ds002338_sub-xp201_sig.pdf}
        \end{subfigure} \\
        %% sub 8
        \begin{subfigure}[b][][c]{0.01\paperwidth} 8 \vspace*{15pt} \end{subfigure}
        \begin{subfigure}[t]{0.2\paperheight}
            \centering
            \includegraphics[width=\textwidth]{figures/sig/15mm/ieee_ds002338_sub-xp207.pdf}
        \end{subfigure}
        \begin{subfigure}[t]{0.2\paperheight}
            \centering
            \includegraphics[width=\textwidth]{figures/sig/15mm/rr_ds002338_sub-xp207_sig.pdf}
        \end{subfigure}
        \begin{subfigure}[t]{0.2\paperheight}
            \centering
            \includegraphics[width=\textwidth]{figures/sig/15mm/rs_ds002338_sub-xp207_sig.pdf}
        \end{subfigure}
        \begin{subfigure}[t]{0.2\paperheight}
            \centering
            \includegraphics[width=\textwidth]{figures/sig/15mm/rr.rs_ds002338_sub-xp207_sig.pdf}
        \end{subfigure} \\
        \hspace*{6cm} 0 \tikz[baseline=(current bounding box.south)]{
            \draw[left color=red, right color=green!50!black, middle color=yellow]
            (0,0) rectangle (8,0.3);} 12 bits
        \caption{Uncertainty measured for subjects 1 to 8 (from top to bottom) across n=30 perturbed samples, with spatial smoothing (FWHM=15mm). \TG{Is the 3rd column RR+RS? It would be useful to have a few more ticks in the color bar.}}
        \label{fig:uncertainty-maps}

    \end{figure}
\end{landscape}

\subsection{Non-regression test evaluations}

\paragraph{Leave-one-out evaluation.} We implemented a ``leave-one-out" (LOO) evaluation by constructing the non-regression test $n$ times for $n-1$ perturbed results and applying it to the remaining perturbed result.
We model the LOO test using a binomial variable $B(n,1-\alpha)$ where $n$ is the number of repetitions and $1-\alpha$ \TG{use a different notation for alpha?} is the probability of success of a repetition. Under $H_0$ for all voxels, we expect the following bound to be verified:
\[
    1-F(\mathds{1}_n;n,1-\alpha) \leq \alpha_0
\]
where $F(x;n,p)$ is the cumulative distribution function of the Binomial law $B(n,p)$, and $\alpha_0=0.05$.

We applied leave-one-out validation for different confidence values (1-$\alpha$) and different FWHM  values for the 3 types of perturbations (Figure~\ref{fig:loo_bonferroni}). As expected, tests become increasingly permissive for increasing values of $\alpha$ (reduced confidence) and increasing values of FWHM.
As previously observed, the 3 perturbation types behave similarly overall. For each subject, $\alpha$ and FWHM values exist such that the LOO test passes. However, these values importantly vary across subjects, presumably due to heterogeneous data quality. To pass the LOO test with $\alpha=0.05$ for RR perturbations, subjects 2, 6, 7 and 8 require a smoothing size of FWHM=12mm and subjects 3 and 5 require FWHM=15mm. Subjects 1 and 4 never pass the LOO test at this confidence level.
\TG{Add a conclusive sentence}

\begin{figure}
    \centering
    \includegraphics[width=\linewidth]{figures/exclude_mct_fwe_bonferroni.pdf}
    \caption{Leave-one-out evaluation for non-regression tests.
        Binomial one-tailed test with a confidence level of 95\% \TG{so what is the confidence level in the figure? Clarify by using different alpha notations (alpha1, alpha2, etc) for each test.}.
        Red: failed the test. Green: passed the test. \TG{use subject indices (not names) in figure.}}
    \label{fig:loo_bonferroni}
\end{figure}


\paragraph{IEEE check.} We constructed the non-regression test from the $n$ perturbed results and applied
it to each of the 8 IEEE results (one per subject).
The purpose of this check is twofold: (1) to verify that IEEE results pass the non-regression test built
from the reference distribution of their corresponding subject and (2) to verify that IEEE results fail the non-regression test
built from the reference distribution of other subjects.

Figure~\ref{fig:ieee-check} shows the result for increasing values of $\alpha$ and FWHM for the 3 types of perturbations.
Each cell is a comparison matrix where rows represent the reference subject used to build the test and columns represent
the test subject. The ideal non-regression test has green values on the diagonal and red values outside the diagonal.

We first observe that none of the inter-subject tests fail which means
that our test is sufficiently specific to detect
inter-subject variability even with a high smoothing kernel size. However, for low FWHM sizes the non-regression test rejects the IEEE sample of the reference subject,
suggesting a lack of precision. But most importantly, for each subject there is an $\alpha$ and FWHM pair
such that the IEEE check passes. In addition, the IEEE check passes with FWHM=15~mm for all subjects and $\alpha$ values for RR perturbations.

\begin{figure}
    \centering
    \begin{subfigure}[t]{0.7\linewidth}
        \includegraphics[width=\linewidth]{figures/inter-subject/one_mct_fwe_bonferroni_RR.pdf}
    \end{subfigure}
    \begin{subfigure}[t]{0.7\linewidth}
        \includegraphics[width=\linewidth]{figures/inter-subject/one_mct_fwe_bonferroni_RS.pdf}
    \end{subfigure}
    \begin{subfigure}[t]{0.7\linewidth}
        \includegraphics[width=\linewidth]{figures/inter-subject/one_mct_fwe_bonferroni_RR-RS.pdf}
    \end{subfigure}
    \caption{Inter-subject check for from top to bottom RR, RS and RR+RS modes. \TG{add RR, RS, RR+RS to the figure}}
    \label{fig:ieee-check}
\end{figure}

\paragraph{Corrupted template check.}

\begin{figure}
    \centering
    \includegraphics[width=\linewidth]{figures/template/template_fwe_bonferroni.pdf}
    \caption{Corrupted template check for RR, RS and RR+RS mode (Bonferroni correction)}
    \label{fig:template_bonferroni}
\end{figure}

Image registration is a fundamental step during the pre-preprocessing to enable statistical analyses. This step consists of realigning an input image (user space) to a common space (template space). To do so, it exists several templates representing a normal structural brain and \fmriprep uses the ICBM 2009c Nonlinear Asymmetric template~\cite{fonov2011unbiased} used by default. The quality of the template will condition the quality of the registered image~\cite{li2021moving}. Hence, errors in the template should lead to substantial differences in the registered images. We use this principle to build this check and to determine that our non-regression correctly captures these variabilities induced.

To do so, we generated noised versions of the MNI152NLin2009cAsym template where we simulate "dead voxels" by setting the voxel's intensity to 0 for a fraction of the intracranial voxels. Each voxel had the same probability to be drawn no matter its localization or tissue type in the brain. We then executed \fmriprep in IEEE mode (without random perturbations) for each "corrupted template" on each subject.

Figure~\ref{fig:template_bonferroni} shows the results for increasing values of $\alpha$ and FWHM for the 3 types of perturbations. On the left is the percentage of "dead voxels" introduced inside the masked brain. First, the sensitivity of the test to the "dead voxels" is not the same for each subject. On one hand, the test rejects subjects 1, 2, 5 and 6 for small percentages of noise ($\leq 1\%$) even for high FMWH levels. On the other hand, subjects 3, 4, 7 and 8 require a high percentage of noise (80\% for the highest level of smoothing) to be rejected by the test. This distinction between the two groups of subjects is correlated to the average number of significant bits (Figure~\ref{fig:significant-digits}), the first group being the one with the highest average number of significant bits. This distinction is also clearly visible when we look at the uncertainty maps at FMWH=5mm (Figure~\ref{fig:uncertainty_5mm}). This correlation may mean that the test is more permissive to a high percentage of "dead voxels" for subjects having the highest uncertainty (or lowest number of significant bits).

\subsection{Non-regression test application to environment updates}

In this section, we explore the result of the non-regression test in different environments. The goal is to detect factors causing results to be outside accepted variability bounds. We executed \fmriprep in IEEE mode by varying two factors: the CPU architecture to execute on and the \fmriprep version.

\paragraph*{Architecture.} Figure~\ref{fig:arch_bonferroni} shows the results of the non-regression test with the Bonferroni correction for increasing $\alpha$ and FWHM values for the 3 types of perturbations. Table~\ref{tab:index-arch-map} gives the mapping between the architecture used and the letter present on the left y-axis. We see that the architecture used has no impact on the non-regression test since results are identical across architecture for a subject and a perturbation mode given. For subject 1, we see that the variability of the non-regression test results is more important. In conclusion, the perturbation mode used to build the test is more important than the architecture used.


\begin{figure}
    \centering
    \includegraphics[width=\linewidth]{figures/arch/arch_mct_fwe_bonferroni_.pdf}
    \caption{Bonferroni corrected test application on different CPU architectures}
    \label{fig:arch_bonferroni}
\end{figure}

\begin{table}
    \begin{center}
        \begin{tabular}{c|l}
            Index & Architecture                   \\
            \hline
            A     & AMD Rome 7532                  \\
            B     & Intel E5-2683 v4 Broadwell     \\
            C     & Intel Silver 4216 Cascade Lake \\
            D     & Intel Platinum 8160F Skylake   \\
            E     & Intel Gold 5120 Skylake        \\
            F     & Intel Gold 6238 Cascade Lake
        \end{tabular}
    \end{center}
    \caption{Index of CPU architectures for Figure~\ref{fig:arch_bonferroni}. We use the architecture A as a reference.}
    \label{tab:index-arch-map}
\end{table}

\paragraph*{\fmriprep versions.} Figure~\ref{fig:version_bonferroni} shows the results of the non-regression test with the Bonferroni correction for increasing $\alpha$ and FWHM values for the 3 types of perturbations. On the left y-axis is the number of \fmriprep versions used to compute the target image. Overall, we see two observed two groups delimited by the version \texttt{20.2.5}. From version \texttt{20.2.0} to \texttt{20.2.4}, results are identical for a given subject and perturbation mode. Subject 4 passes for some confidence level and FWHM configurations. For the other major versions (21, 22 and 23) the test rejects all the subjects. This result suggests that code modifications introduced with version \texttt{20.2.5} have modified the nature of the results produced by \fmriprep. \TODO{find modifications and why it can explain the results}.

\begin{figure}
    \centering
    \includegraphics[width=\linewidth]{figures/fmriprep-versions/bonferroni.pdf}
    \caption{Bonferroni corrected test applications on different \fmriprep versions.}
    \label{fig:version_bonferroni}
\end{figure}


\section{Discussion}

% summary of results

We have proposed the first approach to build non-regression tests for numerical analysis in the absence of an exact solution, a reference solution and even an acceptable bound of variation around the computed solution. We have applied this approach to \fmriprep, one of the largest processing pipeline in neuroimaging and we have demonstrated that our approach can detect variabilities coming from different \fmriprep versions.

The numerical stability of the results varied across subjects in our study. Subjects were chosen to reflect diverse acquisition qualities, resolutions, ages, and genders. Although our analysis did not precisely determine which factors specifically influenced the non-regression test, we observed that certain smoothing sizes were more appropriate than others, indicating an optimal smoothing bandwidth.

Fuzzy-libmath provides an independent method to evaluate the numerical quality of neuroimaging pipelines since it generates variability comparable to random-seed. The smoothing size tended to affect the performance of the non-regression test, as it rendered the distribution of voxels more normal. However, voxel-wise analysis prevented the prediction of excessively large non-local variations. Incorporating neighborhood information could improve learning, such as using more general deep learning methods like VoxelMorph~\cite{balakrishnan2019voxelmorph}.

The assumption of normality simplifies calculations. The issue with non-parametric methods is that they require large sample sizes ($>100$) to achieve an acceptable confidence level ($>0.95$). However, the acquisition cost for \fmriprep and neuroimaging pipelines in general is prohibitively high in terms of time and storage space. Working on other outputs, such as regions of interest with the produced segmentations, could reduce the volume of elements to be processed and enable more complex analyses in computations.

The solutions obtained for the smoothing kernel size may not be anatomically satisfactory for neuroimaging researchers (FWHM $\geq 15$) in terms of anatomical accuracy, but they are valid from a software engineering perspective, as they allow for the detection of significant changes between different versions of \fmriprep. Although our methods may not be currently applicable for neuroimaging research stricto sensu, they serve as a non-regression test for identifying noticeable differences between computed outputs.

The Bonferroni correction, although conservative, fails to capture observations from reference distributions, as demonstrated by LOO (Figure~\ref{fig:loo_bonferroni}) and IEEE (Figure~\ref{fig:ieee-check}) checks. This could be attributed to two factors. Firstly, voxels in neuroimaging data are not spatially independent, and secondly, perturbed samples used in the analysis are not independent due to the optimization problems involved in pre-processing, such as non-linear registration and bias field correction. These optimization problems do not have analytical solutions and require numerical methods for addressing them. However, due to the inherent complexity of these problems (refs), even small perturbations in the input data can result in substantially different but equally valid computed solutions. As a consequence, minimal variations in calculations introduced by Fuzzy-libmath can lead to significantly different geometric solutions, resulting in regions of high instability within anatomical brain images, particularly at white/grey matter borders (Figure~\ref{fig:uncertainty-maps}). And so when working voxel-wise, the obtained brain geometries can differ significantly at the voxel level, transitioning from intensity levels characteristic of gray matter to white matter, and vice versa. Furthermore, subsampling the solution space of optimization problems may lead to the omission of possible white matter regions where only gray matter was observed, and vice versa.

Nevertheless, our method is sufficiently precise to detect inter-subject variability, even at higher levels of smoothing. The numerical perturbations introduced by Fuzzy-libmath only affect a small portion of the calculations performed in \fmriprep. Although it reproduces the measured variability by varying the random seed, it does not stimulate calculations performed elsewhere in advancing neuroimaging. Extending the test to other application domains where the libmath has little effect on stability~\cite{pepe2022numerical} will require perturbing other computation libraries.

Finally, our method is designed for data that are independent collections of numerical values and does not take into account particular geometries. For example, we treat all spatial axes of the T1 images as equivalent without privileging any particular axis. Furthermore, we consider the absolute value of elements, such as voxel intensity in our case, rather than the relative differences between them. In future work, we plan to extend our test to other types of data, such as those used in functional neuroimaging. In functional neuroimaging, researchers analyze time series of neural activations and are primarily interested in activation potential rather than the absolute magnitude of voxel intensity. Additionally, the treatment of the time axis is different from that of the spatial axes. We will therefore have to take into account time dependencies.

\section{Conclusion}

We have proposed a novel approach for building non-regression tests in numerical analysis, even in the absence of an exact solution, a reference solution, or an acceptable bound of variation around the computed solution. We applied this approach to \fmriprep, one of the largest processing pipelines in neuroimaging, and demonstrated its ability to detect variabilities across different \fmriprep versions.

From a software engineering perspective, our non-regression test applies to a carefully selected database of test subjects, as we were able to identify valid configurations $\alpha$ and FWHM for which the test passed our sanity checks. The identified configurations varied across subjects, depending on the quality of the acquisition data, indicating that our test is robust to heterogeneously quality data.

From a neuroimaging perspective, our analyses revealed significant discrepancies in numerical quality results after preprocessing, with an average of 2 to 10 bits out of 12 bits available. The quality of results varied considerably with the acquisition quality and the chosen random seed. Additionally, spatial smoothing had a notable impact on improving result quality, with improvements of 2 to 10 bits observed for some subjects.

Furthermore, we demonstrated that the Fuzzy-libmath perturbations type yielded comparable numerical quality results to those obtained with random seeds, highlighting the ability of the Monte Carlo arithmetic approach to accurately simulate numerical instabilities. However, it should be noted that some specific random seeds resulted in considerably higher variability, as shown by the results from subject 7 in RR+RS modes (Figure~\ref{fig:uncertainty-maps}).

Our results showed that our test is more sensitive (i.e., has a higher ability to correctly detect true positives) than specific (i.e., has a higher ability to correctly detect true negatives). Specifically, our method exhibited lower specificity for low FWHM values, likely due to the voxel-wise analysis that does not account for neighborhood effects and poor sampling space. This limitation arises from the computational cost of statistical analyses and the acquisition cost of perturbed results. However, our test demonstrated high sensitivity, as we were able to correctly reject target images from different subjects or with low to moderate levels of noise in the registration atlas, depending on the applied FWHM.

In conclusion, our proposed non-regression test represents a novel and effective method for detecting code changes that result in substantial numerical variabilities within results represented as numerical structured grids. By providing a method that relies on a numerical values sample and does not require ad-hoc assumptions specific to a particular numerical scheme, our approach offers a flexible and widely applicable solution for non-regression testing in numerical analysis.
Through our demonstrations on a large neuroimaging pipeline, such as \fmriprep, for the preprocessing step, we have shown the effectiveness of our approach under assumptions of independence and normality.

In future research, we plan to extend our methodology to other data types and investigate its applicability under different statistical hypotheses. This work has the potential to contribute to the development of robust non-regression tests for numerical analysis in diverse scientific domains beyond neuroimaging, further enhancing the reliability and reproducibility of computational results.

\section{Acknowledgments}

Computations were made on the Narval supercomputer from \'Ecole de Technologie
Sup\'erieure (ETS, Montr\'eal), managed by Calcul Qubec and Compute Canada. The
operation of this supercomputer is funded by the Canada Foundation for
Innovation (CFI), Ministre de lconomie, des Sciences et de lInnovation du
Qubec (MESI) and le Fonds de recherche du Qubec  Nature et technologies
(FRQ-NT).


\begin{appendices}
    \section{Results for uncorrected tests}
    \label{appendix:multiple-comparison-tests}

    In absence of multiple comparison correction, we expect
    by construction to incorrectly reject each $H_{0,i}$ with probability $\alpha$ a.k.a
    the per-comparison error rate (PCER). To account for the PCER, we measure the
    fraction of positive z-tests $V_P$ among the $v$ voxels in the image and the
    tested \fmriprep result is considered part of the reference distribution iif:
    \begin{equation}
        V_{P} \leq \alpha.
        \label{eqn:pce}
    \end{equation}

    For each of the $n$ repetitions,
    we measured $V_P$, the fraction of
    positive z-tests among the $v$ voxels as well as $\mathds{1}_n$, the number of repetitions
    that passed the test with Bonferroni correction.

    For the uncorrected tests (Equation~\ref{eqn:pce}), we expect $\overline{V_P}$ to have
    the following upper bound:
    \[
        \overline{V_P} \leq
        \alpha  + t_{29,0.05} \frac{\tilde{\sigma}_{V_P}}{\sqrt{30}}
    \]
    with
    $t_{k,\gamma}$ the $(1-\gamma)$quantile of the Student distribution with $k$ degrees of freedom,
    and $\overline{V_P}$ and $\tilde{\sigma}_{V_P}$ the mean and standard-deviation estimated from
    $n$ $V_P$ measures.
    This confidence interval is obtained from a two-tailed one-sample
    t-test with $n-1$ degrees of freedom at a level of significance $\alpha_0=0.05$:
    \[
        \mathbb{P}
        \left(
        -t_{n-1,\alpha_0/2}
        <
        \dfrac{\overline{V_p} - \alpha}{\tilde{\sigma}_{V_P} / \sqrt{n}}
        <
        t_{n-1,\alpha_0/2}
        \right)
        = 1 - \alpha_0
    \]

    % fraction of positive
    % z-tests $V_P$ among the $v$ voxels should be close to the nomimal value $\alpha$
    % on average. To assess the validity of our LOO test, we test that the average
    % of the $n$ $V_P$ fractions measured belongs to a confidence interval
    % around the nomimal value $\alpha$. To do so, we use  resulting in the
    % following confidence interval for $V_P$:

    % obtained from:


    \begin{figure}
        \centering
        \includegraphics[width=\linewidth]{figures/fmriprep-versions/pce.pdf}
        \caption{Uncorrected test applications on different \fmriprep versions.}
        \label{fig:versions_pce}
    \end{figure}

    \begin{figure}
        \centering
        \includegraphics[width=\linewidth]{figures/arch/arch_pce_.pdf}
        \caption{Uncorrected test applications on CPU architectures.}
        \label{fig:arch_pce}
    \end{figure}


    \section{Uncertainty maps for others FWHM}

    \begin{figure}
        \centering
        \includegraphics[width=\linewidth]{figures/exclude_pce.pdf}
        \caption{PCE}
        \label{fig:loo_pce}
    \end{figure}

    \begin{figure}
        \centering
        \includegraphics[width=\linewidth]{figures/template/template_pce.pdf}
        \caption{Corrupted template check for RR, RS and RR+RS mode (pce)}
    \end{figure}

    \begin{landscape}
        \begin{figure}

            \vspace*{-2cm}
            \centering
            %% sub 1
            \begin{subfigure}[b][][c]{0.01\paperwidth} 1 \vspace*{-45pt} \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                IEEE (T1 intensity)
                \includegraphics[width=\textwidth]{figures/sig/0mm/ieee_ds001600_sub-1.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                RR (significant bits)
                \includegraphics[width=\textwidth]{figures/sig/0mm/rr_ds001600_sub-1_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                RS (significant bits)
                \includegraphics[width=\textwidth]{figures/sig/0mm/rs_ds001600_sub-1_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                RR+RS (significant bits)
                \includegraphics[width=\textwidth]{figures/sig/0mm/rs_ds001600_sub-1_sig.pdf}
            \end{subfigure} \\
            %% sub 2
            \begin{subfigure}[b][][c]{0.01\paperwidth} 2 \vspace*{15pt} \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/0mm/ieee_ds001771_sub-36.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/0mm/rr_ds001771_sub-36_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/0mm/rs_ds001771_sub-36_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/0mm/rr.rs_ds001771_sub-36_sig.pdf}
            \end{subfigure} \\
            %% sub 3
            \begin{subfigure}[b][][c]{0.01\paperwidth} 3 \vspace*{15pt} \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/0mm/ieee_ds000256_sub-CTS201.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/0mm/rr_ds000256_sub-CTS201_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/0mm/rs_ds000256_sub-CTS201_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/0mm/rr.rs_ds000256_sub-CTS201_sig.pdf}
            \end{subfigure} \\
            %% sub 4
            \begin{subfigure}[b][][c]{0.01\paperwidth} 4 \vspace*{15pt} \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/0mm/ieee_ds000256_sub-CTS210.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/0mm/rr_ds000256_sub-CTS210_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/0mm/rs_ds000256_sub-CTS210_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/0mm/rr.rs_ds000256_sub-CTS210_sig.pdf}
            \end{subfigure} \\
            %% sub 5
            \begin{subfigure}[b][][c]{0.01\paperwidth} 5 \vspace*{15pt} \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/0mm/ieee_ds001748_sub-adult15.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/0mm/rr_ds001748_sub-adult15_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/0mm/rs_ds001748_sub-adult15_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/0mm/rr.rs_ds001748_sub-adult15_sig.pdf}
            \end{subfigure} \\
            %% sub 6
            \begin{subfigure}[b][][c]{0.01\paperwidth} 6 \vspace*{15pt} \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/0mm/ieee_ds001748_sub-adult16.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/0mm/rr_ds001748_sub-adult16_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/0mm/rs_ds001748_sub-adult16_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/0mm/rr.rs_ds001748_sub-adult16_sig.pdf}
            \end{subfigure} \\
            %% sub 7
            \begin{subfigure}[b][][c]{0.01\paperwidth} 7 \vspace*{15pt} \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/0mm/ieee_ds002338_sub-xp201.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/0mm/rr_ds002338_sub-xp201_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/0mm/rs_ds002338_sub-xp201_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/0mm/rr.rs_ds002338_sub-xp201_sig.pdf}
            \end{subfigure} \\
            %% sub 8 
            \begin{subfigure}[b][][c]{0.01\paperwidth} 8 \vspace*{15pt} \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/0mm/ieee_ds002338_sub-xp207.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/0mm/rr_ds002338_sub-xp207_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/0mm/rs_ds002338_sub-xp207_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/0mm/rr.rs_ds002338_sub-xp207_sig.pdf}
            \end{subfigure} \\
            \hspace*{6cm} 0 \tikz[baseline=(current bounding box.south)]{
                \draw[left color=red, right color=green!50!black, middle color=yellow]
                (0,0) rectangle (8,0.3);} 12 bits
            \caption{Uncertainty measured for subjects 1 to 8 (from top to bottom) across n=30 for
                (from right to left) IEEE, RR, RS and RR+RS perturbed samples with a spatial smoothing applied (FWHM=0mm). }
            \label{fig:uncertainty_0mm}

        \end{figure}
    \end{landscape}


    \begin{landscape}
        \begin{figure}

            \vspace*{-2cm}
            \centering
            %% sub 1
            \begin{subfigure}[b][][c]{0.01\paperwidth} 1 \vspace*{-45pt} \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                IEEE (T1 intensity)
                \includegraphics[width=\textwidth]{figures/sig/5mm/ieee_ds001600_sub-1.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                RR (significant bits)
                \includegraphics[width=\textwidth]{figures/sig/5mm/rr_ds001600_sub-1_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                RS (significant bits)
                \includegraphics[width=\textwidth]{figures/sig/5mm/rs_ds001600_sub-1_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                RR+RS (significant bits)
                \includegraphics[width=\textwidth]{figures/sig/5mm/rs_ds001600_sub-1_sig.pdf}
            \end{subfigure} \\
            %% sub 2
            \begin{subfigure}[b][][c]{0.01\paperwidth} 2 \vspace*{15pt} \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/5mm/ieee_ds001771_sub-36.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/5mm/rr_ds001771_sub-36_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/5mm/rs_ds001771_sub-36_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/5mm/rr.rs_ds001771_sub-36_sig.pdf}
            \end{subfigure} \\
            %% sub 3
            \begin{subfigure}[b][][c]{0.01\paperwidth} 3 \vspace*{15pt} \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/5mm/ieee_ds000256_sub-CTS201.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/5mm/rr_ds000256_sub-CTS201_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/5mm/rs_ds000256_sub-CTS201_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/5mm/rr.rs_ds000256_sub-CTS201_sig.pdf}
            \end{subfigure} \\
            %% sub 4
            \begin{subfigure}[b][][c]{0.01\paperwidth} 4 \vspace*{15pt} \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/5mm/ieee_ds000256_sub-CTS210.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/5mm/rr_ds000256_sub-CTS210_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/5mm/rs_ds000256_sub-CTS210_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/5mm/rr.rs_ds000256_sub-CTS210_sig.pdf}
            \end{subfigure} \\
            %% sub 5
            \begin{subfigure}[b][][c]{0.01\paperwidth} 5 \vspace*{15pt} \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/5mm/ieee_ds001748_sub-adult15.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/5mm/rr_ds001748_sub-adult15_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/5mm/rs_ds001748_sub-adult15_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/5mm/rr.rs_ds001748_sub-adult15_sig.pdf}
            \end{subfigure} \\
            %% sub 6
            \begin{subfigure}[b][][c]{0.01\paperwidth} 6 \vspace*{15pt} \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/5mm/ieee_ds001748_sub-adult16.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/5mm/rr_ds001748_sub-adult16_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/5mm/rs_ds001748_sub-adult16_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/5mm/rr.rs_ds001748_sub-adult16_sig.pdf}
            \end{subfigure} \\
            %% sub 7
            \begin{subfigure}[b][][c]{0.01\paperwidth} 7 \vspace*{15pt} \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/5mm/ieee_ds002338_sub-xp201.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/5mm/rr_ds002338_sub-xp201_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/5mm/rs_ds002338_sub-xp201_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/5mm/rr.rs_ds002338_sub-xp201_sig.pdf}
            \end{subfigure} \\
            %% sub 8 
            \begin{subfigure}[b][][c]{0.01\paperwidth} 8 \vspace*{15pt} \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/5mm/ieee_ds002338_sub-xp207.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/5mm/rr_ds002338_sub-xp207_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/5mm/rs_ds002338_sub-xp207_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/5mm/rr.rs_ds002338_sub-xp207_sig.pdf}
            \end{subfigure} \\
            \hspace*{6cm} 0 \tikz[baseline=(current bounding box.south)]{
                \draw[left color=red, right color=green!50!black, middle color=yellow]
                (0,0) rectangle (8,0.3);} 12 bits
            \caption{Uncertainty measured for subjects 1 to 8 (from top to bottom) across n=30 for
                (from right to left) IEEE, RR, RS and RR+RS perturbed samples with a spatial smoothing applied (FWHM=5mm). }
            \label{fig:uncertainty_5mm}

        \end{figure}
    \end{landscape}


    \begin{landscape}
        \begin{figure}

            \vspace*{-2cm}
            \centering
            %% sub 1
            \begin{subfigure}[b][][c]{0.01\paperwidth} 1 \vspace*{-45pt} \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                IEEE (T1 intensity)
                \includegraphics[width=\textwidth]{figures/sig/10mm/ieee_ds001600_sub-1.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                RR (significant bits)
                \includegraphics[width=\textwidth]{figures/sig/10mm/rr_ds001600_sub-1_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                RS (significant bits)
                \includegraphics[width=\textwidth]{figures/sig/10mm/rs_ds001600_sub-1_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                RR+RS (significant bits)
                \includegraphics[width=\textwidth]{figures/sig/10mm/rs_ds001600_sub-1_sig.pdf}
            \end{subfigure} \\
            %% sub 2
            \begin{subfigure}[b][][c]{0.01\paperwidth} 2 \vspace*{15pt} \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/10mm/ieee_ds001771_sub-36.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/10mm/rr_ds001771_sub-36_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/10mm/rs_ds001771_sub-36_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/10mm/rr.rs_ds001771_sub-36_sig.pdf}
            \end{subfigure} \\
            %% sub 3
            \begin{subfigure}[b][][c]{0.01\paperwidth} 3 \vspace*{15pt} \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/10mm/ieee_ds000256_sub-CTS201.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/10mm/rr_ds000256_sub-CTS201_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/10mm/rs_ds000256_sub-CTS201_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/10mm/rr.rs_ds000256_sub-CTS201_sig.pdf}
            \end{subfigure} \\
            %% sub 4
            \begin{subfigure}[b][][c]{0.01\paperwidth} 4 \vspace*{15pt} \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/10mm/ieee_ds000256_sub-CTS210.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/10mm/rr_ds000256_sub-CTS210_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/10mm/rs_ds000256_sub-CTS210_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/10mm/rr.rs_ds000256_sub-CTS210_sig.pdf}
            \end{subfigure} \\
            %% sub 5
            \begin{subfigure}[b][][c]{0.01\paperwidth} 5 \vspace*{15pt} \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/10mm/ieee_ds001748_sub-adult15.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/10mm/rr_ds001748_sub-adult15_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/10mm/rs_ds001748_sub-adult15_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/10mm/rr.rs_ds001748_sub-adult15_sig.pdf}
            \end{subfigure} \\
            %% sub 6
            \begin{subfigure}[b][][c]{0.01\paperwidth} 6 \vspace*{15pt} \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/10mm/ieee_ds001748_sub-adult16.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/10mm/rr_ds001748_sub-adult16_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/10mm/rs_ds001748_sub-adult16_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/10mm/rr.rs_ds001748_sub-adult16_sig.pdf}
            \end{subfigure} \\
            %% sub 7
            \begin{subfigure}[b][][c]{0.01\paperwidth} 7 \vspace*{15pt} \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/10mm/ieee_ds002338_sub-xp201.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/10mm/rr_ds002338_sub-xp201_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/10mm/rs_ds002338_sub-xp201_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/10mm/rr.rs_ds002338_sub-xp201_sig.pdf}
            \end{subfigure} \\
            %% sub 8 
            \begin{subfigure}[b][][c]{0.01\paperwidth} 8 \vspace*{15pt} \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/10mm/ieee_ds002338_sub-xp207.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/10mm/rr_ds002338_sub-xp207_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/10mm/rs_ds002338_sub-xp207_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/10mm/rr.rs_ds002338_sub-xp207_sig.pdf}
            \end{subfigure} \\
            \hspace*{6cm} 0 \tikz[baseline=(current bounding box.south)]{
                \draw[left color=red, right color=green!50!black, middle color=yellow]
                (0,0) rectangle (8,0.3);} 12 bits
            \caption{Uncertainty measured for subjects 1 to 8 (from top to bottom) across n=30 for
                (from right to left) IEEE, RR, RS and RR+RS perturbed samples with a spatial smoothing applied (FWHM=10mm). }
            \label{fig:uncertainty_10mm}

        \end{figure}
    \end{landscape}

    \begin{landscape}
        \begin{figure}

            \vspace*{-2cm}
            \centering
            %% sub 1
            \begin{subfigure}[b][][c]{0.01\paperwidth} 1 \vspace*{-45pt} \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                IEEE (T1 intensity)
                \includegraphics[width=\textwidth]{figures/sig/15mm/ieee_ds001600_sub-1.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                RR (significant bits)
                \includegraphics[width=\textwidth]{figures/sig/15mm/rr_ds001600_sub-1_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                RS (significant bits)
                \includegraphics[width=\textwidth]{figures/sig/15mm/rs_ds001600_sub-1_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                RR+RS (significant bits)
                \includegraphics[width=\textwidth]{figures/sig/15mm/rs_ds001600_sub-1_sig.pdf}
            \end{subfigure} \\
            %% sub 2
            \begin{subfigure}[b][][c]{0.01\paperwidth} 2 \vspace*{15pt} \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/15mm/ieee_ds001771_sub-36.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/15mm/rr_ds001771_sub-36_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/15mm/rs_ds001771_sub-36_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/15mm/rr.rs_ds001771_sub-36_sig.pdf}
            \end{subfigure} \\
            %% sub 3
            \begin{subfigure}[b][][c]{0.01\paperwidth} 3 \vspace*{15pt} \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/15mm/ieee_ds000256_sub-CTS201.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/15mm/rr_ds000256_sub-CTS201_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/15mm/rs_ds000256_sub-CTS201_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/15mm/rr.rs_ds000256_sub-CTS201_sig.pdf}
            \end{subfigure} \\
            %% sub 4
            \begin{subfigure}[b][][c]{0.01\paperwidth} 4 \vspace*{15pt} \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/15mm/ieee_ds000256_sub-CTS210.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/15mm/rr_ds000256_sub-CTS210_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/15mm/rs_ds000256_sub-CTS210_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/15mm/rr.rs_ds000256_sub-CTS210_sig.pdf}
            \end{subfigure} \\
            %% sub 5
            \begin{subfigure}[b][][c]{0.01\paperwidth} 5 \vspace*{15pt} \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/15mm/ieee_ds001748_sub-adult15.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/15mm/rr_ds001748_sub-adult15_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/15mm/rs_ds001748_sub-adult15_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/15mm/rr.rs_ds001748_sub-adult15_sig.pdf}
            \end{subfigure} \\
            %% sub 6
            \begin{subfigure}[b][][c]{0.01\paperwidth} 6 \vspace*{15pt} \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/15mm/ieee_ds001748_sub-adult16.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/15mm/rr_ds001748_sub-adult16_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/15mm/rs_ds001748_sub-adult16_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/15mm/rr.rs_ds001748_sub-adult16_sig.pdf}
            \end{subfigure} \\
            %% sub 7
            \begin{subfigure}[b][][c]{0.01\paperwidth} 7 \vspace*{15pt} \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/15mm/ieee_ds002338_sub-xp201.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/15mm/rr_ds002338_sub-xp201_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/15mm/rs_ds002338_sub-xp201_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/15mm/rr.rs_ds002338_sub-xp201_sig.pdf}
            \end{subfigure} \\
            %% sub 8 
            \begin{subfigure}[b][][c]{0.01\paperwidth} 8 \vspace*{15pt} \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/15mm/ieee_ds002338_sub-xp207.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/15mm/rr_ds002338_sub-xp207_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/15mm/rs_ds002338_sub-xp207_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/15mm/rr.rs_ds002338_sub-xp207_sig.pdf}
            \end{subfigure} \\
            \hspace*{6cm} 0 \tikz[baseline=(current bounding box.south)]{
                \draw[left color=red, right color=green!50!black, middle color=yellow]
                (0,0) rectangle (8,0.3);} 12 bits
            \caption{Uncertainty measured for subjects 1 to 8 (from top to bottom) across n=30 for
                (from right to left) IEEE, RR, RS and RR+RS perturbed samples with a spatial smoothing applied (FWHM=15mm). }
            \label{fig:uncertainty_15mm}

        \end{figure}
    \end{landscape}

    \begin{landscape}
        \begin{figure}

            \vspace*{-2cm}
            \centering
            %% sub 1
            \begin{subfigure}[b][][c]{0.01\paperwidth} 1 \vspace*{-45pt} \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                IEEE (T1 intensity)
                \includegraphics[width=\textwidth]{figures/sig/20mm/ieee_ds001600_sub-1.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                RR (significant bits)
                \includegraphics[width=\textwidth]{figures/sig/20mm/rr_ds001600_sub-1_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                RS (significant bits)
                \includegraphics[width=\textwidth]{figures/sig/20mm/rs_ds001600_sub-1_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                RR+RS (significant bits)
                \includegraphics[width=\textwidth]{figures/sig/20mm/rs_ds001600_sub-1_sig.pdf}
            \end{subfigure} \\
            %% sub 2
            \begin{subfigure}[b][][c]{0.01\paperwidth} 2 \vspace*{15pt} \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/20mm/ieee_ds001771_sub-36.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/20mm/rr_ds001771_sub-36_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/20mm/rs_ds001771_sub-36_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/20mm/rr.rs_ds001771_sub-36_sig.pdf}
            \end{subfigure} \\
            %% sub 3
            \begin{subfigure}[b][][c]{0.01\paperwidth} 3 \vspace*{15pt} \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/20mm/ieee_ds000256_sub-CTS201.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/20mm/rr_ds000256_sub-CTS201_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/20mm/rs_ds000256_sub-CTS201_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/20mm/rr.rs_ds000256_sub-CTS201_sig.pdf}
            \end{subfigure} \\
            %% sub 4
            \begin{subfigure}[b][][c]{0.01\paperwidth} 4 \vspace*{15pt} \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/20mm/ieee_ds000256_sub-CTS210.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/20mm/rr_ds000256_sub-CTS210_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/20mm/rs_ds000256_sub-CTS210_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/20mm/rr.rs_ds000256_sub-CTS210_sig.pdf}
            \end{subfigure} \\
            %% sub 5
            \begin{subfigure}[b][][c]{0.01\paperwidth} 5 \vspace*{15pt} \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/20mm/ieee_ds001748_sub-adult15.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/20mm/rr_ds001748_sub-adult15_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/20mm/rs_ds001748_sub-adult15_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/20mm/rr.rs_ds001748_sub-adult15_sig.pdf}
            \end{subfigure} \\
            %% sub 6
            \begin{subfigure}[b][][c]{0.01\paperwidth} 6 \vspace*{15pt} \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/20mm/ieee_ds001748_sub-adult16.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/20mm/rr_ds001748_sub-adult16_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/20mm/rs_ds001748_sub-adult16_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/20mm/rr.rs_ds001748_sub-adult16_sig.pdf}
            \end{subfigure} \\
            %% sub 7
            \begin{subfigure}[b][][c]{0.01\paperwidth} 7 \vspace*{15pt} \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/20mm/ieee_ds002338_sub-xp201.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/20mm/rr_ds002338_sub-xp201_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/20mm/rs_ds002338_sub-xp201_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/20mm/rr.rs_ds002338_sub-xp201_sig.pdf}
            \end{subfigure} \\
            %% sub 8 
            \begin{subfigure}[b][][c]{0.01\paperwidth} 8 \vspace*{15pt} \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/20mm/ieee_ds002338_sub-xp207.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/20mm/rr_ds002338_sub-xp207_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/20mm/rs_ds002338_sub-xp207_sig.pdf}
            \end{subfigure}
            \begin{subfigure}[t]{0.2\paperheight}
                \centering
                \includegraphics[width=\textwidth]{figures/sig/20mm/rr.rs_ds002338_sub-xp207_sig.pdf}
            \end{subfigure} \\
            \hspace*{6cm} 0 \tikz[baseline=(current bounding box.south)]{
                \draw[left color=red, right color=green!50!black, middle color=yellow]
                (0,0) rectangle (8,0.3);} 12 bits
            \caption{Uncertainty measured for subjects 1 to 8 (from top to bottom) across n=30 for
                (from right to left) IEEE, RR, RS and RR+RS perturbed samples with a spatial smoothing applied (FWHM=20mm). }
            \label{fig:uncertainty_20mm}

        \end{figure}
    \end{landscape}


    \section*{Summary \fmriprep versions}

    \begin{itemize}
        \item 20.2.0: first fMRIPrep LTS (long-term support)
        \item 20.2.1:
              \begin{itemize}
                  \item ENH: Output TaskName and timing metadata for all resampled BOLD series (2320)
                  \item ENH: Add --output-layout CLI option to enable BIDS (YODA) mode (2303)
                  \item ENH: Add Docker authentication to increase pull rate limit (2316)
                  \item FIX: Specify logger for warning (2298)
              \end{itemize}
        \item 20.2.2:
              \begin{itemize}
                  \item FIX: Feed NiTransforms with LTAs of type RAS2RAS (2444)
                  \item FIX: Add some clarity to BrokenProcessPool failures (2436)
                  \item FIX: Fall-back to initializing workflow in main process (2435)
                  \item FIX: Raise informative error when duplicate subworkflows are added (2434)
                  \item FIX: Non-existing path or JSON syntax error for --bids-filter-file should raise on error (2331)
                  \item FIX: Ignore SBRef files if --ignore sbref is passed (2370)
                  \item ENH: Relax requirement for PyBIDS databases to exist (2429)
                  \item ENH: Improve \_get\_series\_len performance (2406)
                  \item ENH: Set and track NumPy's random seed (2400)
                  \item DOC: Skull-stripping is forced by default (2430)
                  \item MAINT: Pin nilearn==0.6.2 (2427)
                  \item MAINT: Pin tedana==0.0.9a1 for LTS branch (2403)
                  \item MAINT: Failing CI (2401)
              \end{itemize}
        \item 20.2.3:
              \begin{itemize}
                  \item FIX: Address the problems of a sloppy merge (2468)
                  \item FIX: DerivativesDataSink nondeterministic checksums fixed with niworkflows=~1.3.4 (2458)
                  \item FIX: Address dependency incompatibilities by pinning specific packages (2463)
                  \item FIX: Unprotected import of sentry\_sdk, which is not a dependency (2460)
                  \item ENH: Detect 3D Acknowledgments too-short BOLD series, warn and skip run's workflow building (2461)
                  \item DOC: Transfer duplicated documentation to www.nipreps.org (2469)
                  \item DOC: Better explanation on how spike regressors are generated (2465)
                  \item DOC: Clarify that res-2 entity does not mean 2mm (2466)
                  \item MAINT: Containers - remove /root/.npm (2464)
                  \item MAINT: Back port CircleCI configuration from dev branch (2456)
              \end{itemize}
        \item 20.2.4:
              \begin{itemize}
                  \item FIX: Avoid unnecessary connections based on branching logic (2508)
                  \item FIX: Permit missing TR to show PyBIDS error at workflow construction time (2513)
                  \item FIX: Catch FreeSurfer error related to FIPS being enabled (2490)
                  \item ENH: Use BIDSLayoutIndexer and do not index unnecessary modalities (2494)
                  \item ENH: Slice-timing correction improvements (2565)
              \end{itemize}
        \item 20.2.5:
              \begin{itemize}
                  \item FIX: --slice-time-ref option parsing (2573)
                  \item CI: Add style checks (missing since Travis got throttled) (2570)
                  \item FIX: Resample aseg with nearest-neighbor interpolation (nipreps/smriprep268)
                  \item FIX: Revert to FAST for tissue probability maps (nipreps/smriprep264)
              \end{itemize}
    \end{itemize}

\end{appendices}


\bibliographystyle{alpha}
\bibliography{main}

\end{document}
